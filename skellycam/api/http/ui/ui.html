<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <title>SkellyCam API UI Tester</title>
    <style>
        .image {
            width: 640px;
            height: auto;
        }

        div {
            background-color: #654a7b;
        }

        h1 {
            font-size: 24px;
        }

        button {
            margin-right: 10px;
            padding: 10px;
            font-size: small;
        }

    </style>
    <script>
        let ws;
        let isConnected = false;
        const latestImages = {};
        const imageElements = {};

        function updateStatus() {
            document.getElementById('ws-status').innerText = isConnected ? 'Connected' : 'Disconnected';
        }

        function connectWebSocket() {
            ws = new WebSocket('ws://localhost:8006/skellycam/websocket/connect');

            // websocket helpers
            const decoder = new TextDecoder('utf-8');


            ws.onopen = () => {
                isConnected = true;
                updateStatus();
            };
            ws.onclose = () => {
                isConnected = false;
                updateStatus();
            };
            ws.onmessage = async (event) => {
                // Ensure the event.data is a Blob
                if (event.data instanceof Blob) {
                    // Convert the incoming data to an ArrayBuffer
                    const arrayBuffer = await event.data.arrayBuffer();

                    // Convert ArrayBuffer to a string
                    const jsonString = decoder.decode(arrayBuffer);

                    // Parse the JSON string to a JavaScript object
                    const data = JSON.parse(jsonString);
                    addLogEntry(`Received message with length: ${jsonString.length} from mf_payload# ${data.multi_frame_number}`);
                    console.log(`Received message with length: ${jsonString.length} from mf_payload# ${data.multi_frame_number}`);

                    // Now you can use the data object to update your UI
                    updateImages(data.jpeg_images);
                } else {
                    console.error("Received data is not a Blob.");
                }
            };
        }

        function sendMessage(message) {
            if (isConnected) {
                ws.send(message);
            } else {
                alert('WebSocket is not connected.');
            }
        }

        function updateImages(images) {
            const container = document.getElementById('images-container');
            for (const cameraId in images) {
                if (!imageElements[cameraId]) {
                    const imgBox = document.createElement('div');
                    imgBox.className = 'image-box';
                    const img = document.createElement('img');
                    img.className = 'image';
                    imgBox.appendChild(img);
                    container.appendChild(imgBox);
                    imageElements[cameraId] = img;
                }
                if (images[cameraId]) {
                    imageElements[cameraId].src = 'data:image/jpeg;base64,' + images[cameraId];
                }
            }
        }

        function addLogEntry(entry) {
            const logContainer = document.getElementById('log-container');
            const logEntry = document.createElement('div');
            logEntry.innerText = entry;
            logContainer.prepend(logEntry);

            // Limit the number of log entries to 30
            if (logContainer.children.length > 30) {
                logContainer.removeChild(logContainer.lastChild);
            }
        }

        async function callApi(endpoint, method = 'GET', body = null) {
        try {
            const options = { method };
            if (body) {
                options.headers = { 'Content-Type': 'application/json' };
                options.body = JSON.stringify(body);
            }
            const response = await fetch(endpoint, options);
            const data = await response.json();
            document.getElementById('result').innerText = JSON.stringify(data, null, 2);
            addLogEntry(`Success: ${endpoint} - ${JSON.stringify(data)}`);
        } catch (error) {
            document.getElementById('result').innerText = `Error: ${error.message}`;
            addLogEntry(`Error: ${endpoint} - ${error.message}`);
        }
    }
    </script>
</head>
<body>
<!-- Header Section -->
<h1>SkellyCam API Tester with WebSocket</h1>
<p> WebSocket status: <span id="ws-status">Disconnected</span></p>

<!-- WebSocket Section -->
<button onclick="connectWebSocket()">Connect WebSocket</button>

<!-- API Calls Section -->
<!-- Camera Connection API Calls -->
<button onclick="callApi('http://localhost:8006/skellycam/cameras/connect/detect')">/cameras/connect/detect</button>

<div>
    <button onclick="callApi('http://localhost:8006/skellycam/cameras/connect/apply', 'POST')">/cameras/connect/apply</button>
    <button onclick="callApi('http://localhost:8006/skellycam/cameras/close')">Close Camera Connections</button>

    <!-- Root and App API Calls -->
    <button onclick="sendMessage('Hello from the client')">Send WS Message</button>
    <button onclick="callApi('http://localhost:8006/skellycam/')">Read Root</button>
    <button onclick="callApi('http://localhost:8006/skellycam/app/state')">App State</button>
    <button onclick="callApi('http://localhost:8006/skellycam/app/healthcheck')">HelloðŸ‘‹</button>
    <button onclick="callApi('http://localhost:8006/skellycam/app_state/shutdown')">goodbyeðŸ‘‹</button>


    <!-- Camera Operation API Calls -->
    <button onclick="callApi('http://localhost:8006/skellycam/cameras/detect')">Detect Cameras</button>
    <button onclick="callApi('http://localhost:8006/skellycam/cameras/record/start')">Start Recording</button>
    <button onclick="callApi('http://localhost:8006/skellycam/cameras/record/stop')">Stop Recording</button>

    <!-- Video Playback API Calls -->
    <button onclick="callApi('http://localhost:8006/skellycam/video_playback/open_videos', 'POST', '/Users/philipqueen/freemocap_data/recording_sessions/freemocap_test_data/synchronized_videos')">Open Videos</button>
    <button onclick="callApi('http://localhost:8006/skellycam/video_playback/close_videos')">Close Videos</button>
    <button onclick="callApi('http://localhost:8006/skellycam/video_playback/play_videos')">Play Videos</button>
    <button onclick="callApi('http://localhost:8006/skellycam/video_playback/pause_videos')">Pause Videos</button>
    <button onclick="callApi('http://localhost:8006/skellycam/video_playback/stop_videos')">Stop Videos</button>
    <button onclick="callApi('http://localhost:8006/skellycam/video_playback/seek_videos')">Seek Videos</button>
</div>
<!-- Results and Logs Section -->
<pre id="result"></pre>
<h2>Images</h2>
<div id="images-container"></div>

<h3>Loggs</h3>
<div id="log-container"></div>
</body>
</html>
